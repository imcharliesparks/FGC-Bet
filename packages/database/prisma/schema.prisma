generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String        @id @default(cuid())
  clerkId           String        @unique
  email             String        @unique
  username          String?       @unique
  firstName         String?
  lastName          String?
  imageUrl          String?
  chipBalance       Decimal       @default(10000) @db.Decimal(10,2)
  preferredGames    FightingGame[]
  emailNotifications Boolean      @default(true)
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  lastLoginAt       DateTime?
  bets              Bet[]
  transactions      Transaction[]
  
  @@index([clerkId])
  @@index([email])
}

model Tournament {
  id                String        @id @default(cuid())
  startGgId         String?       @unique
  name              String
  slug              String        @unique
  game              FightingGame
  startDate         DateTime
  endDate           DateTime?
  location          String?
  streamUrl         String?
  imageUrl          String?
  isActive          Boolean       @default(true)
  isFeatured        Boolean       @default(false)
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  matches           Match[]
  
  @@index([game, startDate])
  @@index([isActive, isFeatured])
}

model Player {
  id                String        @id @default(cuid())
  startGgId         String?       @unique
  gamerTag          String        @unique
  country           String?
  mainCharacter     String?
  imageUrl          String?
  twitterHandle     String?
  totalMatches      Int           @default(0)
  wins              Int           @default(0)
  losses            Int           @default(0)
  eloRating         Int           @default(1500)
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  player1Matches    Match[]       @relation("Player1Matches")
  player2Matches    Match[]       @relation("Player2Matches")
  
  @@index([gamerTag])
  @@index([eloRating])
}

model Match {
  id                String        @id @default(cuid())
  startGgId         String?       @unique
  tournamentId      String
  tournament        Tournament    @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  round             String
  game              FightingGame
  bestOf            Int           @default(3)
  player1Id         String
  player1           Player        @relation("Player1Matches", fields: [player1Id], references: [id])
  player2Id         String
  player2           Player        @relation("Player2Matches", fields: [player2Id], references: [id])
  status            MatchStatus   @default(SCHEDULED)
  scheduledStart    DateTime
  actualStart       DateTime?
  completedAt       DateTime?
  winnerId          String?
  player1Score      Int?
  player2Score      Int?
  bettingOpen       Boolean       @default(false)
  bettingClosedAt   DateTime?
  streamUrl         String?
  vodUrl            String?
  notes             String?       @db.Text
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  bets              Bet[]
  oddsHistory       OddsSnapshot[]
  
  @@index([tournamentId, scheduledStart])
  @@index([status, bettingOpen])
  @@index([game, status])
}

model OddsSnapshot {
  id                String        @id @default(cuid())
  matchId           String
  match             Match         @relation(fields: [matchId], references: [id], onDelete: Cascade)
  betType           BetType
  player1Odds       Decimal       @db.Decimal(6,2)
  player2Odds       Decimal       @db.Decimal(6,2)
  line              Decimal?      @db.Decimal(3,1)
  overOdds          Decimal?      @db.Decimal(6,2)
  underOdds         Decimal?      @db.Decimal(6,2)
  player1Volume     Decimal       @default(0) @db.Decimal(10,2)
  player2Volume     Decimal       @default(0) @db.Decimal(10,2)
  overVolume        Decimal       @default(0) @db.Decimal(10,2)
  underVolume       Decimal       @default(0) @db.Decimal(10,2)
  timestamp         DateTime      @default(now())
  
  @@index([matchId, timestamp])
  @@index([matchId, betType])
}

model Bet {
  id                String        @id @default(cuid())
  userId            String
  user              User          @relation(fields: [userId], references: [id])
  matchId           String
  match             Match         @relation(fields: [matchId], references: [id], onDelete: Cascade)
  betType           BetType
  selection         BetSelection
  amount            Decimal       @db.Decimal(10,2)
  odds              Decimal       @db.Decimal(6,2)
  potentialPayout   Decimal       @db.Decimal(10,2)
  status            BetStatus     @default(PENDING)
  placedAt          DateTime      @default(now())
  settledAt         DateTime?
  actualPayout      Decimal?      @db.Decimal(10,2)
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  @@index([userId, status])
  @@index([matchId, status])
  @@index([placedAt])
}

model Transaction {
  id                String        @id @default(cuid())
  userId            String
  user              User          @relation(fields: [userId], references: [id])
  type              TransactionType
  amount            Decimal       @db.Decimal(10,2)
  balanceBefore     Decimal       @db.Decimal(10,2)
  balanceAfter      Decimal       @db.Decimal(10,2)
  relatedBetId      String?
  description       String?
  createdAt         DateTime      @default(now())

  @@index([userId, createdAt])
  @@index([type, createdAt])
}

model StartGGTournament {
  id                   String              @id @default(cuid())
  startGgId            Int                 @unique
  name                 String
  slug                 String              @unique
  startAt              DateTime
  endAt                DateTime?
  city                 String?
  countryCode          String?
  state                String?
  venueAddress         String?
  venueName            String?
  numAttendees         Int?
  primaryContact       String?
  registrationClosesAt DateTime?
  timezone             String?
  imageUrl             String?
  bannerUrl            String?
  hashtag              String?
  isOnline             Boolean             @default(false)
  hasOfflineEvents     Boolean             @default(false)

  // Sync metadata
  lastSyncedAt         DateTime            @default(now())
  syncStatus           StartGGSyncStatus   @default(PENDING)
  syncError            String?

  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt

  events               StartGGEvent[]
  participants         StartGGParticipant[]

  @@index([startAt])
  @@index([syncStatus])
  @@index([lastSyncedAt])
}

model StartGGEvent {
  id              String              @id @default(cuid())
  startGgId       Int                 @unique
  tournamentId    String
  tournament      StartGGTournament   @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  name            String
  slug            String
  type            Int?
  videogameId     Int
  videogameName   String
  startAt         DateTime?
  numEntrants     Int?
  state           String?
  isOnline        Boolean             @default(false)

  // Sync metadata
  lastSyncedAt    DateTime            @default(now())
  syncStatus      StartGGSyncStatus   @default(PENDING)
  syncError       String?

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  sets            StartGGSet[]
  entrants        StartGGEntrant[]

  @@index([tournamentId])
  @@index([videogameId])
  @@index([syncStatus])
}

model StartGGSet {
  id              String              @id @default(cuid())
  startGgId       Int                 @unique
  eventId         String
  event           StartGGEvent        @relation(fields: [eventId], references: [id], onDelete: Cascade)
  phaseId         Int?
  phaseGroupId    Int?

  // Set details
  fullRoundText   String?
  round           Int?
  identifier      String?
  state           Int

  // Timing
  startAt         DateTime?
  startedAt       DateTime?
  completedAt     DateTime?

  // Slot 1 (Player/Team 1)
  slot1EntrantId  String?
  slot1Entrant    StartGGEntrant?     @relation("Slot1Sets", fields: [slot1EntrantId], references: [id])
  slot1Score      Int?
  slot1Standing   Int?

  // Slot 2 (Player/Team 2)
  slot2EntrantId  String?
  slot2Entrant    StartGGEntrant?     @relation("Slot2Sets", fields: [slot2EntrantId], references: [id])
  slot2Score      Int?
  slot2Standing   Int?

  // Result
  winnerId        Int?
  displayScore    String?
  totalGames      Int?
  bestOf          Int?

  // Stream info
  streamUrl       String?
  stationNumber   Int?

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([eventId])
  @@index([state])
  @@index([startAt])
  @@index([completedAt])
}

model StartGGEntrant {
  id              String              @id @default(cuid())
  startGgId       Int                 @unique
  eventId         String
  event           StartGGEvent        @relation(fields: [eventId], references: [id], onDelete: Cascade)
  name            String
  initialSeedNum  Int?

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  participants    StartGGParticipant[]
  slot1Sets       StartGGSet[]        @relation("Slot1Sets")
  slot2Sets       StartGGSet[]        @relation("Slot2Sets")

  @@index([eventId])
  @@index([name])
}

enum FightingGame {
  STREET_FIGHTER_6
  TEKKEN_8
  GUILTY_GEAR_STRIVE
  MORTAL_KOMBAT_1
  GRANBLUE_FANTASY_VERSUS
  KING_OF_FIGHTERS_XV
  UNDER_NIGHT
  BLAZBLUE
  DRAGON_BALL_FIGHTERZ
  SKULLGIRLS
  MULTIVERSUS
  SUPER_SMASH_BROS_MELEE
  SUPER_SMASH_BROS_ULTIMATE
  SUPER_SMASH_BROS_BRAWL
  TWOXKO
  OTHER
}

enum StartGGSyncStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

enum ImportJobStatus {
  PENDING
  RUNNING
  PAUSED
  COMPLETED
  FAILED
  CANCELLED
}

enum MatchStatus {
  SCHEDULED
  LIVE
  COMPLETED
  CANCELLED
  POSTPONED
}

enum BetType {
  MONEYLINE
  HANDICAP
  TOTAL_GAMES
}

enum BetSelection {
  PLAYER_1
  PLAYER_2
  OVER
  UNDER
}

enum BetStatus {
  PENDING
  WON
  LOST
  CANCELLED
  PUSHED
}

enum TransactionType {
  BET_PLACED
  BET_WON
  BET_LOST
  BET_REFUND
  ADMIN_ADJUSTMENT
  DAILY_BONUS
  WELCOME_BONUS
}
